---
name: Build

# yamllint disable-line rule:truthy
on: [push, pull_request]

env:
    SETUPTOOLS_ENABLE_FEATURES: legacy-editable

jobs:
    build_wheels:
        name: Build wheels on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                # ubuntu-latest fails because Pillow doesn't find jpeg headers.
                os: [windows-2019, macOS-latest, ubuntu-latest]

        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-python@v2

            - name: Setup GNU Fortran
              uses: modflowpy/install-gfortran-action@v1

            - name: Linux
              if: contains(matrix.os, 'linux')
              run: |
                  sudo apt-get install libhdf5-dev

            - name: Windows
              if: contains(matrix.os, 'win')
              run: |
                  choco install hdf5

            - name: Build wheels
              uses: pypa/cibuildwheel@v2.12.0
              env:
                  FC: gfortran
                  CIBW_SKIP: pp* cp36-* cp37-*
                  CIBW_TEST_REQUIRES: pytest
                  CIBW_TEST_COMMAND: pytest {package}/tests
                  CIBW_BUILD_VERBOSITY_WINDOWS: 3
                  CIBW_BEFORE_BUILD_ALL: |
                      python -m pip install --upgrade pip
                      python -m pip install --upgrade 'setuptools>=45'
                      python -m pip install --upgrade 'setuptools-scm>=6.2'
                      python -m pip install --upgrade wheel
                      python -m pip install --upgrade twine
                      python -m pip install --upgrade numpy

            - name: Build and upload
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_WDMTOOLBOX_TOKEN }}
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install --upgrade 'setuptools>=45'
                  python -m pip install --upgrade 'setuptools-scm>=6.2'
                  python -m pip install --upgrade wheel
                  python -m pip install --upgrade twine
                  python -m pip install --upgrade numpy
                  python setup.py sdist
                  twine upload --verbose dist/*
                  twine upload --verbose wheelhouse/*
